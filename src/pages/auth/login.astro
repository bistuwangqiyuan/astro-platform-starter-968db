---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Input from '../../components/ui/Input.astro';
import Button from '../../components/ui/Button.astro';

// 检查用户是否已登录
import { getCurrentUser } from '../../utils/auth';

// 如果已登录，重定向到首页
const user = await getCurrentUser();
if (user) {
  return Astro.redirect('/');
}
---

<BaseLayout title="登录">
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-md mx-auto">
      <h1 class="text-3xl font-bold mb-8 text-center">登录</h1>
      
      <form id="loginForm" class="space-y-6">
        <div>
          <label for="email" class="block text-sm font-medium mb-2">
            邮箱地址
          </label>
          <Input
            type="email"
            id="email"
            name="email"
            required
            placeholder="your@email.com"
            class="w-full"
          />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium mb-2">
            密码
          </label>
          <Input
            type="password"
            id="password"
            name="password"
            required
            placeholder="••••••••"
            class="w-full"
          />
        </div>

        <div id="error-message" class="text-red-600 text-sm hidden"></div>
        <div id="success-message" class="text-green-600 text-sm hidden"></div>

        <Button type="submit" variant="primary" class="w-full">
          登录
        </Button>
      </form>

      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">
          还没有账户？
          <a href="/auth/register" class="text-blue-600 hover:underline">
            立即注册
          </a>
        </p>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // 登录表单处理
  const loginForm = document.getElementById('loginForm') as HTMLFormElement;
  const errorMessage = document.getElementById('error-message') as HTMLDivElement;
  const successMessage = document.getElementById('success-message') as HTMLDivElement;

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // 重置消息
    errorMessage.classList.add('hidden');
    successMessage.classList.add('hidden');
    
    // 获取表单数据
    const formData = new FormData(loginForm);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;
    
    console.log('[Login] 开始登录请求', { email });
    
    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password }),
      });
      
      const data = await response.json();
      
      if (response.ok) {
        console.log('[Login] 登录成功', data);
        successMessage.textContent = '登录成功！正在跳转...';
        successMessage.classList.remove('hidden');
        
        // 跳转到首页或之前的页面
        const redirectTo = new URLSearchParams(window.location.search).get('redirect') || '/';
        setTimeout(() => {
          window.location.href = redirectTo;
        }, 1000);
      } else {
        console.log('[Login] 登录失败', data);
        errorMessage.textContent = data.error || '登录失败，请重试';
        errorMessage.classList.remove('hidden');
      }
    } catch (error) {
      console.error('[Login] 登录出错', error);
      errorMessage.textContent = '网络错误，请稍后重试';
      errorMessage.classList.remove('hidden');
    }
  });
</script>